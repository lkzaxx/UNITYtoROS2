version: '3.8'

services:
  # ä¸»è¦çš„ ROS2 TCP Endpoint æœå‹™
  ros2-tcp-endpoint:
    image: osrf/ros:humble-desktop
    container_name: unity_ros2_tcp
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
    volumes:
      # æºç¢¼ç›®éŒ„æ˜ å°„
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
      # Cyclone DDS é…ç½®
      - ./cyclonedds.xml:/etc/cyclonedds.xml:ro
      # æŒä¹…åŒ–å®‰è£ç›®éŒ„ï¼ˆå¯é¸ï¼‰
      - ros2_install:/ros2_ws/install
      - ros2_build:/ros2_ws/build
    ports:
      # TCP Endpoint ç«¯å£
      - "10000:10000"
      # DDS ç™¼ç¾ç«¯å£ï¼ˆå¦‚éœ€è·¨å®¹å™¨é€šè¨Šï¼‰
      - "7400:7400/udp"
      - "7410-7420:7410-7420/udp"
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash &&

        echo 'ğŸ“¦ å®‰è£ç³»çµ±ä¾è³´...' &&
        apt-get update &&
        apt-get install -y \
          python3-pip \
          ros-humble-ros-tcp-endpoint \
          ros-humble-tf2-ros \
          ros-humble-tf2-geometry-msgs \
          git &&

        echo 'ğŸ“¦ å®‰è£ Python å¥—ä»¶...' &&
        pip3 install --no-cache-dir \
          numpy \
          transforms3d \
          pyyaml &&

        echo 'ğŸ“¥ æª¢æŸ¥ ROS-TCP-Endpoint...' &&
        if [ ! -d /ros2_ws/src/ros_tcp_endpoint ]; then
          cd /ros2_ws/src &&
          git clone https://github.com/Unity-Technologies/ROS-TCP-Endpoint.git ros_tcp_endpoint
        fi &&

        echo 'ğŸ”¨ å»ºç½® ROS2 å¥—ä»¶...' &&
        cd /ros2_ws &&
        colcon build --symlink-install &&
        source install/setup.bash &&

        echo 'ğŸš€ å•Ÿå‹• TCP Endpoint ä¼ºæœå™¨...' &&
        ros2 run ros_tcp_endpoint default_server_endpoint \
          --ros-args \
          -p ROS_IP:=0.0.0.0 \
          -p ROS_TCP_PORT:=10000 &

        echo 'â³ ç­‰å¾… TCP Endpoint å•Ÿå‹•...' &&
        sleep 5 &&

        echo 'ğŸ”„ å•Ÿå‹• Unity OpenArm æ©‹æ¥ç¯€é»...' &&
        if [ -f /ros2_ws/install/unity_openarm_bridge/lib/unity_openarm_bridge/tcp_bridge_node.py ]; then
          python3 /ros2_ws/install/unity_openarm_bridge/lib/unity_openarm_bridge/tcp_bridge_node.py
        elif [ -f /scripts/unity_tcp_bridge.py ]; then
          python3 /scripts/unity_tcp_bridge.py
        else
          echo 'âŒ æ‰¾ä¸åˆ°æ©‹æ¥ç¯€é»è…³æœ¬ï¼' &&
          echo 'è«‹ç¢ºä¿ unity_tcp_bridge.py åœ¨ scripts ç›®éŒ„ä¸­' &&
          tail -f /dev/null
        fi
      "
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && ros2 topic list"]
      interval: 30s
      timeout: 10s
      retries: 3

  # OpenArm æ§åˆ¶å™¨æœå‹™
  openarm-controller:
    image: osrf/ros:humble-desktop
    container_name: openarm_controller
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
      - ./cyclonedds.xml:/etc/cyclonedds.xml:ro
      - ros2_install:/ros2_ws/install
      - ros2_build:/ros2_ws/build
    depends_on:
      - ros2-tcp-endpoint
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash &&

        echo 'â³ ç­‰å¾… TCP Endpoint æœå‹™å°±ç·’...' &&
        sleep 10 &&

        echo 'ğŸ”¨ å»ºç½® OpenArm å¥—ä»¶...' &&
        cd /ros2_ws &&
        if [ -d src/unity_openarm_bridge ]; then
          colcon build --packages-select unity_openarm_bridge --symlink-install &&
          source install/setup.bash
        fi &&

        echo 'ğŸ® å•Ÿå‹• OpenArm æ§åˆ¶å™¨...' &&
        if [ -f /ros2_ws/install/unity_openarm_bridge/lib/unity_openarm_bridge/openarm_controller.py ]; then
          python3 /ros2_ws/install/unity_openarm_bridge/lib/unity_openarm_bridge/openarm_controller.py
        else
          echo 'â„¹ï¸ OpenArm æ§åˆ¶å™¨å°šæœªå¯¦ä½œï¼Œä¿æŒå®¹å™¨é‹è¡Œ...' &&
          tail -f /dev/null
        fi
      "
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ROS2 å·¥å…·å’Œç›£æ§å®¹å™¨
  ros2-tools:
    image: osrf/ros:humble-desktop
    container_name: ros2_tools
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
      - ./cyclonedds.xml:/etc/cyclonedds.xml:ro
      - ros2_install:/ros2_ws/install:ro
      - ros2_build:/ros2_ws/build:ro
    depends_on:
      - ros2-tcp-endpoint
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash &&

        echo 'ğŸ”§ å®‰è£ç›£æ§å·¥å…·...' &&
        apt-get update &&
        apt-get install -y \
          ros-humble-rqt \
          ros-humble-rqt-topic \
          ros-humble-rqt-graph \
          ros-humble-plotjuggler-ros &&

        if [ -f /ros2_ws/install/setup.bash ]; then
          source /ros2_ws/install/setup.bash
        fi &&

        echo 'ğŸ“Š ROS2 å·¥å…·å®¹å™¨å°±ç·’' &&
        echo '' &&
        echo 'å¯ç”¨å‘½ä»¤ç¯„ä¾‹ï¼š' &&
        echo '  æŸ¥çœ‹ä¸»é¡Œåˆ—è¡¨ï¼š' &&
        echo '    ros2 topic list' &&
        echo '' &&
        echo '  ç›£è½å¿ƒè·³è¨Šè™Ÿï¼š' &&
        echo '    ros2 topic echo /unity/heartbeat' &&
        echo '' &&
        echo '  ç›£è½é—œç¯€ç‹€æ…‹ï¼š' &&
        echo '    ros2 topic echo /openarm/joint_states' &&
        echo '' &&
        echo '  ç™¼é€é—œç¯€å‘½ä»¤ï¼š' &&
        echo '    ros2 topic pub /unity/joint_commands sensor_msgs/msg/JointState \"{header: {stamp: now}, name: [joint_1, joint_2], position: [0.0, 0.0]}\"' &&
        echo '' &&
        echo '  æª¢æŸ¥æœå‹™ï¼š' &&
        echo '    ros2 service list' &&
        echo '' &&
        echo '  å‘¼å« Ping æœå‹™ï¼š' &&
        echo '    ros2 service call /unity/ping example_interfaces/srv/Trigger' &&
        echo '' &&
        echo '  å•Ÿå‹• RQT åœ–å½¢ç•Œé¢ï¼š' &&
        echo '    rqt' &&
        echo '' &&
        echo '  æŸ¥çœ‹ç¯€é»é—œä¿‚åœ–ï¼š' &&
        echo '    ros2 run rqt_graph rqt_graph' &&
        echo '' &&
        bash
      "
    stdin_open: true
    tty: true

  # å¯é¸ï¼šRViz2 è¦–è¦ºåŒ–å®¹å™¨ï¼ˆéœ€è¦ X11 æ”¯æ´ï¼‰
  rviz2:
    image: osrf/ros:humble-desktop-full
    container_name: ros2_rviz
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    volumes:
      - ./src:/ros2_ws/src:ro
      - ./cyclonedds.xml:/etc/cyclonedds.xml:ro
      - ros2_install:/ros2_ws/install:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/root/.Xauthority:rw
    depends_on:
      - ros2-tcp-endpoint
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash &&

        if [ -f /ros2_ws/install/setup.bash ]; then
          source /ros2_ws/install/setup.bash
        fi &&

        echo 'ğŸ–¼ï¸ å•Ÿå‹• RViz2...' &&
        echo 'â„¹ï¸ å¦‚æœçœ‹ä¸åˆ°è¦–çª—ï¼Œè«‹ç¢ºä¿ X11 forwarding å·²è¨­å®š' &&
        echo 'åœ¨ WSL ä¸­åŸ·è¡Œ: export DISPLAY=:0' &&

        rviz2
      "
    stdin_open: true
    tty: true
    profiles:
      - visualization

# å®šç¾© volumes ç”¨æ–¼æŒä¹…åŒ–å»ºç½®çµæœ
volumes:
  ros2_install:
    driver: local
  ros2_build:
    driver: local

# ç¶²è·¯é…ç½®ï¼ˆå¯é¸ï¼‰
networks:
  default:
    name: ros2_unity_network
    driver: bridge