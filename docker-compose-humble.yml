version: '3.8'

services:
  # ä¸»è¦çš„ ROS2 TCP Endpoint æœå‹™
  ros2-tcp-endpoint:
    image: osrf/ros:humble-desktop
    container_name: unity_ros2_tcp
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    command: >
      bash -c "
      echo '========================================' &&
      echo 'ğŸš€ Unity-OpenArm ROS2 ç’°å¢ƒåˆå§‹åŒ–' &&
      echo '========================================' &&
      echo '' &&
      
      echo 'ğŸ”§ [1/6] æ›´æ–°å¥—ä»¶åˆ—è¡¨...' &&
      apt-get update -qq &&
      
      echo 'ğŸ“¦ [2/6] å®‰è£å¿…è¦å¥—ä»¶...' &&
      apt-get install -y -qq \
        ros-humble-rmw-cyclonedds-cpp \
        python3-pip \
        python3-colcon-common-extensions \
        git &&
      
      echo 'ğŸ“¦ [3/6] å®‰è£ Python ä¾è³´...' &&
      pip3 install -q numpy transforms3d pyyaml &&
      
      echo 'ğŸ” [4/6] æª¢æŸ¥ä¸¦å…‹éš†å¿…è¦çš„å¥—ä»¶...' &&
      cd /ros2_ws/src &&
      if [ ! -d ros_tcp_endpoint ]; then
        echo '   ğŸ“¥ å…‹éš† ROS-TCP-Endpoint...' &&
        git clone -q https://github.com/Unity-Technologies/ROS-TCP-Endpoint.git ros_tcp_endpoint
      else
        echo '   âœ“ ros_tcp_endpoint å·²å­˜åœ¨'
      fi &&
      
      echo 'ğŸ”¨ [5/6] ç·¨è­¯ ROS2 å·¥ä½œå€...' &&
      cd /ros2_ws &&
      source /opt/ros/humble/setup.bash &&
      export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp &&
      
      echo '   æ­£åœ¨ç·¨è­¯å¥—ä»¶ï¼šros_tcp_endpoint, unity_openarm_bridge' &&
      colcon build --symlink-install \
        --packages-select ros_tcp_endpoint unity_openarm_bridge \
        --cmake-args -DCMAKE_BUILD_TYPE=Release 2>&1 | grep -E '(Starting|Finished|Failed|Summary)' &&
      
      if [ -f install/setup.bash ]; then
        source install/setup.bash &&
        echo '   âœ“ ç·¨è­¯å®Œæˆ' &&
        echo '' &&
        echo '   å¯ç”¨å¥—ä»¶:' &&
        ros2 pkg list | grep -E '(tcp|unity)' | sed 's/^/     - /'
      else
        echo '   âš ï¸  ç·¨è­¯å¤±æ•—ï¼Œä½†å®¹å™¨ä»æœƒå•Ÿå‹•' 
      fi &&
      
      echo '' &&
      echo 'ğŸš€ [6/6] å•Ÿå‹•æœå‹™...' &&
      source /opt/ros/humble/setup.bash &&
      export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp &&
      
      if [ -f install/setup.bash ]; then
        source install/setup.bash &&
        
        echo '   ğŸŒ å•Ÿå‹• TCP Endpoint (Port: 10000)...' &&
        ros2 run ros_tcp_endpoint default_server_endpoint \
          --ros-args \
          -p ROS_IP:=0.0.0.0 \
          -p ROS_TCP_PORT:=10000 &
        TCP_PID=\$$! &&
        
        sleep 3 &&
        
        echo '   ğŸ¤– å•Ÿå‹• Unity-OpenArm Bridge...' &&
        python3 -m unity_openarm_bridge.tcp_bridge_node &
        BRIDGE_PID=\$$! &&
        
        echo '' &&
        echo '========================================' &&
        echo 'âœ… æ‰€æœ‰æœå‹™å·²å•Ÿå‹•ï¼' &&
        echo '========================================' &&
        echo '' &&
        echo 'ğŸ“¡ æœå‹™ç‹€æ…‹:' &&
        echo '   â€¢ TCP Endpoint: ç›£è½ 0.0.0.0:10000' &&
        echo '   â€¢ Unity Bridge: é‹è¡Œä¸­' &&
        echo '' &&
        echo 'ğŸ”— Unity é€£æ¥è¨­å®š:' &&
        echo '   â€¢ ROS IP: 127.0.0.1 æˆ– localhost' &&
        echo '   â€¢ ROS Port: 10000' &&
        echo '' &&
        echo 'ğŸ“ å¯ç”¨å‘½ä»¤:' &&
        echo '   â€¢ æŸ¥çœ‹ä¸»é¡Œ: ros2 topic list' &&
        echo '   â€¢ æŸ¥çœ‹æœå‹™: ros2 service list' &&
        echo '   â€¢ ç›£æ§å¿ƒè·³: ros2 topic echo /unity/heartbeat' &&
        echo '' &&
        echo 'ğŸ›‘ åœæ­¢å®¹å™¨: docker-compose down' &&
        echo '========================================' &&
        echo '' &&
        
        wait \$$TCP_PID \$$BRIDGE_PID
      else
        echo '   âš ï¸  æœªæ‰¾åˆ°ç·¨è­¯çµæœï¼Œåƒ…å•Ÿå‹•åŸºç¤ç’°å¢ƒ' &&
        tail -f /dev/null
      fi
      "
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f default_server_endpoint > /dev/null && pgrep -f tcp_bridge_node > /dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ROS2 å·¥å…·å’Œç›£æ§å®¹å™¨
  ros2-tools:
    image: osrf/ros:humble-desktop
    container_name: ros2_tools
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    depends_on:
      ros2-tcp-endpoint:
        condition: service_healthy
    command: >
      bash -c "
      echo '========================================' &&
      echo 'ğŸ”§ ROS2 å·¥å…·å®¹å™¨' &&
      echo '========================================' &&
      echo '' &&
      
      apt-get update -qq &&
      apt-get install -y -qq ros-humble-rmw-cyclonedds-cpp &&
      
      cd /ros2_ws &&
      source /opt/ros/humble/setup.bash &&
      export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp &&
      
      if [ -f install/setup.bash ]; then
        source install/setup.bash
      fi &&
      
      echo 'ğŸ“Š å·¥å…·å®¹å™¨å°±ç·’' &&
      echo '' &&
      echo 'ğŸ’¡ å¿«é€Ÿå‘½ä»¤:' &&
      echo '   ros2 topic list              # åˆ—å‡ºæ‰€æœ‰ä¸»é¡Œ' &&
      echo '   ros2 topic echo /unity/heartbeat  # ç›£æ§å¿ƒè·³' &&
      echo '   ros2 service list            # åˆ—å‡ºæ‰€æœ‰æœå‹™' &&
      echo '   ros2 node list               # åˆ—å‡ºæ‰€æœ‰ç¯€é»' &&
      echo '' &&
      echo 'ğŸ¯ é€²å…¥äº’å‹•æ¨¡å¼...' &&
      echo '' &&
      
      exec bash
      "
    stdin_open: true
    tty: true
    restart: unless-stopped