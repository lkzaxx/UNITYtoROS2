version: '3.8'

services:
  ros2-tcp-endpoint:
    image: osrf/ros:humble-desktop
    container_name: unity_ros2_tcp
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src:/ros2_ws/src              # ä¿®æ­£ï¼šæ˜ å°„ src ç›®éŒ„
      - ./scripts:/scripts               # ä¿®æ­£ï¼šæ˜ å°„ scripts ç›®éŒ„
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash &&
        
        # å®‰è£å¿…è¦çš„å¥—ä»¶
        apt-get update &&
        apt-get install -y python3-pip ros-humble-ros-tcp-endpoint &&
        
        # å®‰è£ Python å¥—ä»¶
        pip3 install --no-cache-dir \
          numpy \
          transforms3d &&
        
        # å»ºç½® ROS2 å¥—ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d /ros2_ws/src/unity_openarm_bridge ]; then
          echo 'ğŸ“¦ å»ºç½® unity_openarm_bridge å¥—ä»¶...' &&
          cd /ros2_ws &&
          colcon build --packages-select unity_openarm_bridge --symlink-install &&
          source install/setup.bash
        fi &&
        
        # å•Ÿå‹• TCP Endpointï¼ˆèƒŒæ™¯åŸ·è¡Œï¼‰
        echo 'ğŸš€ å•Ÿå‹• ROS TCP Endpoint...' &&
        ros2 run ros_tcp_endpoint default_server_endpoint \
          --ros-args \
          -p ROS_IP:=0.0.0.0 \
          -p ROS_TCP_PORT:=10000 &
        
        # ç­‰å¾… TCP Endpoint å•Ÿå‹•
        sleep 5 &&
        
        # å•Ÿå‹•æ©‹æ¥ç¯€é»
        echo 'ğŸ”„ å•Ÿå‹• Unity æ©‹æ¥ç¯€é»...' &&
        if [ -f /ros2_ws/install/setup.bash ]; then
          source /ros2_ws/install/setup.bash &&
          ros2 run unity_openarm_bridge tcp_bridge_node
        else
          python3 /scripts/unity_tcp_bridge.py
        fi
      "
    stdin_open: true
    tty: true

  # å¯é¸ï¼šç¨ç«‹çš„ ROS2 å·¥å…·å®¹å™¨ï¼ˆç”¨æ–¼æ¸¬è©¦å’Œç›£æ§ï¼‰
  ros2-tools:
    image: osrf/ros:humble-desktop
    container_name: ros2_tools
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash &&
        echo 'ğŸ”§ ROS2 å·¥å…·å®¹å™¨å°±ç·’' &&
        echo 'å¯ç”¨å‘½ä»¤ï¼š' &&
        echo '  ros2 topic list' &&
        echo '  ros2 topic echo /unity/heartbeat' &&
        echo '  ros2 topic echo /openarm/joint_states' &&
        echo '  ros2 topic pub /unity/joint_commands sensor_msgs/msg/JointState ...' &&
        bash
      "
    stdin_open: true
    tty: true