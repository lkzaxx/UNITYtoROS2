version: "3.8"

services:
  # ä¸»æœå‹™å®¹å™¨ - é‹è¡Œ TCP Endpoint å’Œ Unity Bridge
  unity_ros2_tcp:
    container_name: unity_ros2_tcp
    image: osrf/ros:humble-desktop
    hostname: ros2_humble
    network_mode: host
    stdin_open: true
    tty: true
    
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - DISPLAY=host.docker.internal:0.0
      - CYCLONEDDS_URI=file:///ros2_ws/cyclonedds.xml
    
    volumes:
      # æ›è¼‰æºç¢¼ç›®éŒ„
      - ./src:/ros2_ws/src:rw
      - ./scripts:/ros2_ws/scripts:rw
      
      # å‰µå»ºæŒä¹…åŒ–çš„ç·¨è­¯ç›®éŒ„
      - ros2_build:/ros2_ws/build
      - ros2_install:/ros2_ws/install
      - ros2_log:/ros2_ws/log
    
    working_dir: /ros2_ws
    
    # ä½¿ç”¨é™£åˆ—æ ¼å¼é¿å… YAML è½‰ç¾©å­—ç¬¦å•é¡Œ
    command: ["/bin/bash", "-c", "
      set -e &&
      echo '========================================' &&
      echo 'ğŸš€ Unity-OpenArm ROS2 ç’°å¢ƒåˆå§‹åŒ–' &&
      echo '========================================' &&
      echo '' &&
      echo 'ğŸ”§ [1/6] æ›´æ–°å¥—ä»¶åˆ—è¡¨...' &&
      apt-get update -qq &&
      echo 'ğŸ“¦ [2/6] å®‰è£å¿…è¦å¥—ä»¶...' &&
      apt-get install -y -qq ros-humble-rmw-cyclonedds-cpp python3-pip python3-colcon-common-extensions git &&
      echo 'ğŸ“¦ [3/6] å®‰è£ Python ä¾è³´...' &&
      pip3 install --quiet transforms3d &&
      echo 'ğŸ” [4/6] æª¢æŸ¥ä¸¦å…‹éš†å¿…è¦çš„å¥—ä»¶...' &&
      cd /ros2_ws/src &&
      if [ ! -d 'ros_tcp_endpoint' ]; then
        echo '  å…‹éš† ros_tcp_endpoint...' &&
        git clone https://github.com/Unity-Technologies/ROS-TCP-Endpoint.git ros_tcp_endpoint --quiet;
      fi &&
      if [ ! -d 'unity_openarm_bridge' ]; then
        echo '  å‰µå»º unity_openarm_bridge å¥—ä»¶...' &&
        mkdir -p unity_openarm_bridge &&
        echo '<?xml version=\"1.0\"?><package format=\"3\"><name>unity_openarm_bridge</name><version>0.1.0</version><description>Unity OpenArm Bridge</description><maintainer email=\"you@example.com\">Your Name</maintainer><license>MIT</license><buildtool_depend>ament_cmake</buildtool_depend><depend>rclpy</depend><depend>std_msgs</depend><depend>sensor_msgs</depend><depend>trajectory_msgs</depend><export><build_type>ament_cmake</build_type></export></package>' > unity_openarm_bridge/package.xml &&
        echo 'cmake_minimum_required(VERSION 3.8)\nproject(unity_openarm_bridge)\nfind_package(ament_cmake REQUIRED)\nament_package()' > unity_openarm_bridge/CMakeLists.txt;
      fi &&
      echo 'ğŸ”¨ [5/6] ç·¨è­¯ ROS2 å·¥ä½œå€...' &&
      cd /ros2_ws &&
      source /opt/ros/humble/setup.bash &&
      colcon build --symlink-install --packages-select ros_tcp_endpoint unity_openarm_bridge &&
      echo 'ğŸš€ [6/6] å•Ÿå‹•æœå‹™...' &&
      source install/setup.bash &&
      echo '<?xml version=\"1.0\" encoding=\"UTF-8\" ?><CycloneDDS xmlns=\"https://cdds.io/config\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"https://cdds.io/config https://raw.githubusercontent.com/eclipse-cyclonedds/cyclonedds/master/etc/cyclonedds.xsd\"><Domain id=\"any\"><General><NetworkInterfaceAddress>lo</NetworkInterfaceAddress></General></Domain></CycloneDDS>' > /ros2_ws/cyclonedds.xml &&
      echo '' &&
      echo 'âœ… æ‰€æœ‰æœå‹™å·²å•Ÿå‹•ï¼' &&
      echo 'ğŸ“¡ æœå‹™ç‹€æ…‹:' &&
      echo '   â€¢ TCP Endpoint: ç›£è½ 0.0.0.0:10000' &&
      echo '   â€¢ Unity Bridge: é‹è¡Œä¸­' &&
      echo '' &&
      ros2 run ros_tcp_endpoint default_server_endpoint --ros-args -p ROS_IP:=0.0.0.0 -p ROS_TCP_PORT:=10000
    "]
    
    healthcheck:
      test: ["CMD", "bash", "-c", "pgrep -f 'ros_tcp_endpoint' && pgrep -f 'unity_openarm_bridge' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
    
    restart: unless-stopped

  # å·¥å…·å®¹å™¨ - ç”¨æ–¼èª¿è©¦å’Œç›£æ§
  ros2_tools:
    container_name: ros2_tools
    image: osrf/ros:humble-desktop
    hostname: ros2_tools
    network_mode: host
    stdin_open: true
    tty: true
    
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///cyclonedds.xml
    
    volumes:
      - ./src:/ros2_ws/src:ro
      - ./scripts:/scripts:ro
    
    working_dir: /
    
    # ä½¿ç”¨é™£åˆ—æ ¼å¼é¿å… YAML è½‰ç¾©å­—ç¬¦å•é¡Œ
    command: ["/bin/bash", "-c", "
      apt-get update -qq &&
      apt-get install -y -qq ros-humble-rmw-cyclonedds-cpp &&
      echo '<?xml version=\"1.0\" encoding=\"UTF-8\" ?><CycloneDDS xmlns=\"https://cdds.io/config\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"https://cdds.io/config https://raw.githubusercontent.com/eclipse-cyclonedds/cyclonedds/master/etc/cyclonedds.xsd\"><Domain id=\"any\"><General><NetworkInterfaceAddress>lo</NetworkInterfaceAddress></General></Domain></CycloneDDS>' > /cyclonedds.xml &&
      echo 'ğŸ› ï¸ ROS2 å·¥å…·å®¹å™¨å·²å°±ç·’' &&
      echo 'ğŸ“ å¯ç”¨å‘½ä»¤:' &&
      echo '   â€¢ ros2 topic list' &&
      echo '   â€¢ ros2 topic echo /unity/heartbeat' &&
      echo '   â€¢ ros2 node list' &&
      echo '   â€¢ ros2 service list' &&
      bash
    "]
    
    restart: unless-stopped

volumes:
  ros2_build:
  ros2_install:
  ros2_log:

networks:
  default:
    driver: bridge