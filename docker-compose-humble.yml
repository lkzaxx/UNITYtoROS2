version: '3.8'

services:
  # ä¸»è¦çš„ ROS2 TCP Endpoint æœå‹™
  ros2-tcp-endpoint:
    image: osrf/ros:humble-desktop
    container_name: unity_ros2_tcp
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
    command: ["/bin/bash", "-c", "
        # ç§»é™¤ set -e é¿å…ä»»ä½•éŒ¯èª¤å°è‡´å®¹å™¨é€€å‡º
        echo 'ğŸ”§ æ›´æ–°å¥—ä»¶åˆ—è¡¨...' &&
        apt-get update || echo 'âš ï¸  æ›´æ–°å¥—ä»¶åˆ—è¡¨å¤±æ•—,ç¹¼çºŒåŸ·è¡Œ...' &&

        echo 'ğŸ“¦ å®‰è£ Cyclone DDS...' &&
        apt-get install -y ros-humble-rmw-cyclonedds-cpp || echo 'âš ï¸  Cyclone DDS å®‰è£å¤±æ•—' &&

        echo 'ğŸ“¦ å®‰è£ ROS-TCP-Endpoint...' &&
        (apt-get install -y ros-humble-ros-tcp-endpoint ||
        (
          echo 'âš ï¸  ros-tcp-endpoint ä¸åœ¨å®˜æ–¹åº«ä¸­,å¾æºç¢¼å®‰è£...' &&
          apt-get install -y git python3-pip &&
          cd /ros2_ws/src &&
          if [ ! -d ros_tcp_endpoint ]; then
            git clone https://github.com/Unity-Technologies/ROS-TCP-Endpoint.git ros_tcp_endpoint || echo 'âš ï¸  ç„¡æ³•å…‹éš† ros_tcp_endpoint';
          fi
        )) &&

        echo 'ğŸ“¦ å®‰è£ Python ä¾è³´...' &&
        apt-get install -y python3-pip &&
        pip3 install numpy transforms3d pyyaml || echo 'âš ï¸  Python ä¾è³´å®‰è£å¤±æ•—' &&

        echo 'ğŸ”¨ å»ºç½® ROS2 å·¥ä½œå€...' &&
        cd /ros2_ws &&
        source /opt/ros/humble/setup.bash &&
        export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp &&

        if [ -d src/ros_tcp_endpoint ] || [ -d src/unity_openarm_bridge ]; then
          apt-get install -y python3-colcon-common-extensions &&
          colcon build --symlink-install || echo 'âš ï¸  å»ºç½®å¤±æ•—,è·³é...' &&
          if [ -f install/setup.bash ]; then
            source install/setup.bash;
          fi;
        fi &&

        echo 'âœ… ç’°å¢ƒè¨­å®šå®Œæˆ' &&
        echo 'ğŸš€ å•Ÿå‹• TCP Endpoint ä¼ºæœå™¨...' &&
        source /opt/ros/humble/setup.bash &&
        export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp &&

        if [ -f install/setup.bash ]; then
          source install/setup.bash;
        fi &&

        # åœ¨èƒŒæ™¯å•Ÿå‹• TCP Endpoint
        (ros2 run ros_tcp_endpoint default_server_endpoint --ros-args -p ROS_IP:=0.0.0.0 -p ROS_TCP_PORT:=10000 &) || echo 'âš ï¸  TCP Endpoint å•Ÿå‹•å¤±æ•—' &&

        echo 'â³ ç­‰å¾… TCP Endpoint å•Ÿå‹•...' &&
        sleep 5 &&

        echo 'ğŸ“¡ TCP Endpoint æ‡‰è©²åœ¨ port 10000 ä¸Šç›£è½' &&
        echo 'ğŸ” å®¹å™¨ä¿æŒé‹è¡Œä¸­...' &&
        
        # ä¿æŒå®¹å™¨é‹è¡Œ
        tail -f /dev/null
      "]
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "default_server_endpoint"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ROS2 å·¥å…·å’Œç›£æ§å®¹å™¨
  ros2-tools:
    image: osrf/ros:humble-desktop
    container_name: ros2_tools
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src:/ros2_ws/src
      - ./scripts:/scripts
    depends_on:
      - ros2-tcp-endpoint
    command: ["/bin/bash", "-c", "
        echo 'ğŸ”§ è¨­å®š ROS2 å·¥å…·ç’°å¢ƒ...' &&
        apt-get update &&
        apt-get install -y ros-humble-rmw-cyclonedds-cpp &&

        source /opt/ros/humble/setup.bash &&
        export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp &&

        echo 'ğŸ“Š ROS2 å·¥å…·å®¹å™¨å°±ç·’' &&
        echo '' &&
        echo 'å¯ç”¨å‘½ä»¤ç¯„ä¾‹:' &&
        echo '  ros2 topic list' &&
        echo '  ros2 topic echo /unity/heartbeat' &&
        echo '  ros2 topic echo /openarm/joint_states' &&
        echo '  ros2 service list' &&
        echo '' &&
        exec bash
      "]
    stdin_open: true
    tty: true
    restart: unless-stopped